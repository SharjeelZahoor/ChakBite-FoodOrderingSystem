{% extends 'core/base.html' %}
{% block title %}ChakBites - Checkout{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="mb-4">Checkout</h1>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Delivery Information</h5>
                </div>
                <div class="card-body">
                    <form id="checkout-form">
                        <div class="mb-3">
                            <label class="form-label">Order Type</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="order_type" id="delivery" value="D" checked>
                                    <label class="form-check-label" for="delivery">Delivery</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="order_type" id="onspot" value="O">
                                    <label class="form-check-label" for="onspot">On-Spot</label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="delivery-address-section">
                            <div class="mb-3">
                                <label for="delivery_address" class="form-label">Delivery Address</label>
                                <textarea class="form-control" id="delivery_address" name="delivery_address" rows="3" required>{{ request.user.userprofile.address }}</textarea>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="notes" class="form-label">Special Instructions</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Order Items</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Pizza</th>
                                    <th>Size</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cart.items.all %}
                                <tr>
                                    <td>{{ item.pizza.name }}</td>
                                    <td>{{ item.get_size_display }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>Rs. {{ item.get_price }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span id="subtotal">Rs. {% widthratio cart.total 1 1 %}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Delivery Fee:</span>
                        <span id="delivery-fee">Rs. 50</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <h5>Total:</h5>
                        <h5 id="total">Rs. {% widthratio cart.total 1 1 %}</h5>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_method" id="cod" value="Cash on Delivery" checked>
                            <label class="form-check-label" for="cod">
                                Cash on Delivery
                            </label>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-danger w-100" id="place-order-btn">Place Order</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle delivery address section
        document.querySelectorAll('input[name="order_type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const deliverySection = document.getElementById('delivery-address-section');
                if (this.value === 'D') {
                    deliverySection.style.display = 'block';
                    document.getElementById('delivery_address').required = true;
                } else {
                    deliverySection.style.display = 'none';
                    document.getElementById('delivery_address').required = false;
                }
                updateOrderSummary();
            });
        });
        
        // Update order summary
        function updateOrderSummary() {
            const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace('Rs. ', ''));
            const orderType = document.querySelector('input[name="order_type"]:checked').value;
            const deliveryFee = orderType === 'D' ? 50 : 0;
            const total = subtotal + deliveryFee;
            
            document.getElementById('delivery-fee').textContent = 'Rs. ' + deliveryFee.toFixed(2);
            document.getElementById('total').textContent = 'Rs. ' + total.toFixed(2);
        }
        
        // Place order
        document.getElementById('place-order-btn').addEventListener('click', function() {
            const orderType = document.querySelector('input[name="order_type"]:checked').value;
            const deliveryAddress = document.getElementById('delivery_address').value;
            const notes = document.getElementById('notes').value;
            const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
            
            fetch('/api/orders/checkout/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                },
                body: JSON.stringify({
                    order_type: orderType,
                    delivery_address: deliveryAddress,
                    notes: notes,
                    payment_method: paymentMethod
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    alert('Order placed successfully! Your order ID is #' + data.id);
                    window.location.href = '/orders/';
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        });
        
        // Initialize
        updateOrderSummary();
    });
</script>
{% endblock %}